<!DOCTYPE html>
<html lang="de" data-theme="emerald">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabellen auswählen - Access Database Converter</title>

  <!-- CSS/JS (CDN nur für Dev) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* Seite darf natürlich scrollen */
    html { height:auto; min-height:100%; overflow-y:auto; }
    body { min-height:100vh; overflow-y:auto; margin:0; }

    .glass-card {
      background: rgba(255,255,255,.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.2);
    }
    .table-card { transition: all .3s ease; cursor: pointer; }
    .table-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
    .table-card.selected { border-color:#10b981; background-color: rgba(16,185,129,.1); }
  </style>
</head>

<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 min-h-screen flex flex-col">
  <!-- Navigation -->
  <nav class="navbar glass-card shadow-lg mb-8">
    <div class="navbar-start">
      <div class="text-xl font-bold text-emerald-700">
        <i class="fas fa-database mr-2"></i> Access Converter
      </div>
    </div>
    <div class="navbar-end">
      <div class="badge badge-emerald" x-data="{ version: 'latest' }" x-init="loadVersion()" x-text="version">latest</div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8 max-w-6xl flex-1" x-data="tableSelector('{{ job_id }}')">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">
        <span class="bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
          Tabellen auswählen
        </span>
      </h1>
      <p class="text-lg text-gray-600">Wählen Sie die Tabellen aus, die Sie konvertieren möchten</p>
      {% if job %}
      <div class="mt-4">
        <div class="badge badge-outline badge-lg">
          <i class="fas fa-file-database mr-2"></i> {{ job.original_filename }}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center py-12">
      <div class="loading loading-spinner loading-lg text-emerald-500"></div>
      <p class="mt-4 text-gray-600">Lade Tabellen...</p>
    </div>

    <!-- Error -->
    <div x-show="error" class="alert alert-error mb-8">
      <i class="fas fa-exclamation-triangle"></i>
      <span x-text="error"></span>
      <button @click="loadTables()" class="btn btn-ghost btn-sm">
        <i class="fas fa-redo mr-1"></i> Erneut versuchen
      </button>
    </div>

    <!-- Content -->
    <template x-if="!loading && !error && tables.length > 0">
      <div>
        <!-- Controls -->
        <div class="card glass-card shadow-lg mb-8 overflow-visible">
          <div class="card-body">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div class="flex gap-2">
                <button @click="selectAll()" class="btn btn-sm btn-outline btn-primary">
                  <i class="fas fa-check-double mr-1"></i> Alle auswählen
                </button>
                <button @click="deselectAll()" class="btn btn-sm btn-outline">
                  <i class="fas fa-times mr-1"></i> Alle abwählen
                </button>
              </div>
              <div class="form-control">
                <label class="label"><span class="label-text font-medium">Export-Format:</span></label>
                <select x-model="selectedFormat" class="select select-bordered select-sm w-full max-w-xs">
                  <option value="csv">CSV</option>
                  <option value="xlsx">Excel (XLSX)</option>
                  <option value="json">JSON</option>
                  <option value="pdf">PDF</option>
                </select>
              </div>
              <div class="text-right">
                <div class="stat">
                  <div class="stat-value text-2xl text-emerald-600" x-text="selectedTables.length"></div>
                  <div class="stat-desc">von <span x-text="tables.length"></span> ausgewählt</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tables Grid (Seite scrollt, kein innerer Lock) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <template x-for="table in tables" :key="table.name">
            <div class="table-card card glass-card shadow-lg border-2 border-transparent overflow-visible"
                 :class="{ 'selected': selectedTables.includes(table.name) }"
                 @click="toggleTable(table.name)">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="card-title text-lg">
                      <i class="fas fa-table text-emerald-500 mr-2"></i>
                      <span x-text="table.name"></span>
                    </h3>
                    <div class="flex gap-4 mt-2 text-sm text-gray-600">
                      <span x-show="table.row_count !== null">
                        <i class="fas fa-list-ol mr-1"></i><span x-text="table.row_count"></span> Zeilen
                      </span>
                      <span x-show="table.column_count !== null">
                        <i class="fas fa-columns mr-1"></i><span x-text="table.column_count"></span> Spalten
                      </span>
                    </div>
                  </div>
                  <input type="checkbox"
                         :checked="selectedTables.includes(table.name)"
                         @click.stop="toggleTable(table.name)"
                         class="checkbox checkbox-primary">
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- Erweiterte Export-Optionen -->
        <div class="card glass-card shadow-lg mb-8 overflow-visible">
          <div class="card-body">
            <h3 class="card-title text-lg mb-4">
              <i class="fas fa-cogs text-emerald-500 mr-2"></i>
              Erweiterte Export-Optionen
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Pivot-Tabellen Option -->
              <div class="form-control">
                <label class="label cursor-pointer">
                  <span class="label-text">
                    <i class="fas fa-chart-pie mr-2 text-blue-500"></i>
                    <span class="font-medium">Pivot-Tabellen</span>
                    <div class="text-sm text-gray-500 mt-1">
                      Erstellt automatisch Pivot-Auswertungen in Excel
                    </div>
                  </span>
                  <input type="checkbox" x-model="createPivotTables" 
                         :disabled="selectedFormat !== 'xlsx'"
                         class="checkbox checkbox-primary" />
                </label>
              </div>
              
              <!-- Query-Export Option -->
              <div class="form-control">
                <label class="label cursor-pointer">
                  <span class="label-text">
                    <i class="fas fa-search mr-2 text-purple-500"></i>
                    <span class="font-medium">Abfragen exportieren</span>
                    <div class="text-sm text-gray-500 mt-1">
                      Exportiert gespeicherte Access-Abfragen und deren Ergebnisse
                    </div>
                  </span>
                  <input type="checkbox" x-model="exportQueries" class="checkbox checkbox-primary" />
                </label>
              </div>
              
              <!-- Schema-Export Option -->
              <div class="form-control">
                <label class="label cursor-pointer">
                  <span class="label-text">
                    <i class="fas fa-project-diagram mr-2 text-orange-500"></i>
                    <span class="font-medium">Schema exportieren</span>
                    <div class="text-sm text-gray-500 mt-1">
                      Erstellt Datenbankschema (JSON) und ER-Diagramm
                    </div>
                  </span>
                  <input type="checkbox" x-model="exportSchema" class="checkbox checkbox-primary" />
                </label>
              </div>
            </div>
            
            <!-- Hinweise -->
            <div x-show="createPivotTables && selectedFormat !== 'xlsx'" class="alert alert-warning mt-4">
              <i class="fas fa-exclamation-triangle"></i>
              <span>Pivot-Tabellen sind nur bei Excel-Export verfügbar. Bitte wählen Sie XLSX als Format.</span>
            </div>
            
            <div x-show="exportQueries || exportSchema" class="alert alert-info mt-4">
              <i class="fas fa-info-circle"></i>
              <span>
                Erweiterte Optionen werden zusätzlich zu den Tabellendaten exportiert und im ZIP-Archiv bereitgestellt.
              </span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="card glass-card shadow-lg overflow-visible">
          <div class="card-body">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <a href="/" class="btn btn-outline">
                <i class="fas fa-arrow-left mr-2"></i> Neue Datei hochladen
              </a>
              <button @click="startConversion()"
                      :disabled="selectedTables.length === 0 || converting"
                      class="btn btn-primary btn-lg px-8"
                      :class="{ 'loading': converting }">
                <i class="fas fa-play mr-2" x-show="!converting"></i>
                <span x-text="converting ? 'Konvertierung läuft...' : 'Konvertierung starten'"></span>
              </button>
            </div>
            <div x-show="selectedTables.length === 0" class="mt-4">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Bitte wählen Sie mindestens eine Tabelle aus.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- No Tables -->
    <div x-show="!loading && !error && tables.length === 0" class="text-center py-12">
      <i class="fas fa-table text-6xl text-gray-400 mb-4"></i>
      <h3 class="text-2xl font-bold text-gray-600 mb-2">Keine Tabellen gefunden</h3>
      <p class="text-gray-500 mb-6">Die Datenbank enthält keine lesbaren Tabellen.</p>
      <a href="/" class="btn btn-primary"><i class="fas fa-upload mr-2"></i> Andere Datei hochladen</a>
    </div>

    <!-- Progress Modal -->
    <div x-show="showProgress" x-transition.opacity class="modal" :class="{ 'modal-open': showProgress }">
      <div class="modal-box">
        <h3 class="font-bold text-lg text-center mb-4">
          <i class="fas fa-cogs text-emerald-500 mr-2"></i> Konvertierung läuft
        </h3>
        <div class="text-center mb-6">
          <div class="radial-progress text-emerald-500 mb-4" :style="`--value:${progress}; --size:6rem;`">
            <span x-text="progress + '%'"></span>
          </div>
          <p class="text-gray-600" x-text="progressMessage"></p>
        </div>
        <div class="mb-4">
          <div class="flex justify-between text-sm text-gray-600 mb-1">
            <span>Fortschritt</span><span x-text="progress + '%'"></span>
          </div>
          <progress class="progress progress-primary w-full" :value="progress" max="100"></progress>
        </div>
        <div x-show="progress === 100" class="text-center">
          <button @click="downloadResults()" class="btn btn-success btn-lg">
            <i class="fas fa-download mr-2"></i> Ergebnisse herunterladen
          </button>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button @click="showProgress=false">Schließen</button>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer footer-center p-4 glass-card text-base-content">
    <div><p x-data="{ version: 'v2.2' }" x-init="loadVersion()" x-text="`Copyright © 2025 GCNG Software - Rene Süß - Access Database Converter ${version}`">Copyright © 2025 GCNG Software - Rene Süß - Access Database Converter v2.2</p></div>
  </footer>

  <script>
    function tableSelector(jobId) {
      return {
        jobId, tables: [], selectedTables: [], selectedFormat: 'csv',
        loading: true, error: null, converting: false,
        showProgress: false, progress: 0, progressMessage: '', pollingInterval: null,
        // Erweiterte Export-Optionen
        createPivotTables: false,
        exportQueries: false,
        exportSchema: false,

        async init(){ await this.loadTables(); },

        async loadTables(){
          this.loading = true; this.error = null;
          try{
            const r = await fetch(`/tables/${this.jobId}`);
            if(!r.ok){ const e = await r.json().catch(()=>({})); throw new Error(e.detail || `HTTP ${r.status}`); }
            const data = await r.json();
            this.tables = data.tables.map(name => ({ name, row_count:null, column_count:null }));
          } catch(err){ this.error = err.message || 'Fehler beim Laden der Tabellen'; console.error(err);
          } finally { this.loading = false; }
        },

        toggleTable(n){ const i=this.selectedTables.indexOf(n); i>-1?this.selectedTables.splice(i,1):this.selectedTables.push(n); },
        selectAll(){ this.selectedTables = this.tables.map(t=>t.name); },
        deselectAll(){ this.selectedTables = []; },

        async startConversion(){
          console.log('startConversion called'); // Debug
          if(!this.selectedTables.length || this.converting) {
            console.log('No tables selected or already converting');
            return;
          }
          console.log('Starting conversion for tables:', this.selectedTables);
          this.converting = true;
          this.error = null;
          try{
            const requestData = {
              selected_tables: this.selectedTables,
              export_format: this.selectedFormat,
              create_pivot_tables: this.createPivotTables,
              export_queries: this.exportQueries,
              export_schema: this.exportSchema
            };
            console.log('Request data:', requestData);
            
            const r = await fetch(`/convert/${this.jobId}`, {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify(requestData)
            });
            console.log('Response status:', r.status);
            if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error(e.detail || `HTTP ${r.status}`); }
            const result = await r.json();
            console.log('Conversion response:', result);
            console.log('Setting showProgress to true');
            this.showProgress = true; 
            console.log('showProgress is now:', this.showProgress);
            this.startProgressPolling();
          } catch(err){ 
            console.error('Conversion error:', err);
            this.error = err.message || 'Konvertierung fehlgeschlagen'; 
          } finally { this.converting = false; }
        },

        startProgressPolling(){
          this.pollingInterval = setInterval(async () => {
            try{
              const r = await fetch(`/status/${this.jobId}`);
              if(!r.ok) return;
              const s = await r.json();
              this.progress = s.progress; this.progressMessage = s.message || '';
              if(s.status === 'completed'){ clearInterval(this.pollingInterval); }
              if(s.status === 'failed'){ clearInterval(this.pollingInterval); this.error = s.message || 'Fehler'; this.showProgress=false; }
            } catch(err){ console.error(err); }
          }, 1000);
        },

        async downloadResults(){
          try{
            const r = await fetch(`/download/${this.jobId}`);
            if(!r.ok) throw new Error('Download fehlgeschlagen');
            const blob = await r.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `database_export_${this.selectedFormat}.zip`;
            document.body.appendChild(a); a.click();
            URL.revokeObjectURL(url); a.remove();
            this.showProgress = false; setTimeout(()=>location.href='/', 1500);
          } catch(err){ this.error = err.message || 'Netzwerkfehler beim Download'; console.error(err); }
        }
      };
    }
    
    // Global function to load version
    async function loadVersion() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          this.version = `v${config.app_version}`;
        }
      } catch (error) {
        console.log('Using default version:', error);
      }
    }
  </script>
</body>
</html>